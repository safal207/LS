# –ü–∏—Ä–∞–º–∏–¥–∞ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Testing Pyramid)

## Overview

–ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º, –≥–¥–µ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –∏–º–µ–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é —Ü–µ–ª—å, scope –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤.

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   E2E      ‚îÇ  5-10%
                    ‚îÇ   Tests    ‚îÇ  (8 tests)
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ  Integration     ‚îÇ  15-25%
               ‚îÇ  Tests           ‚îÇ  (pending)
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ      Unit Tests           ‚îÇ  60-80%
         ‚îÇ      (153 tests)          ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –£—Ä–æ–≤–Ω–∏ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. üü¢ Unit Tests (–ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å) ‚Äî 153 —Ç–µ—Å—Ç–∞

**–¶–µ–ª—å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∫–ª–∞—Å—Å–æ–≤ –∏ –º–æ–¥—É–ª–µ–π –≤ –∏–∑–æ–ª—è—Ü–∏–∏.

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–¥–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–º–æ–∫–∞–Ω—ã (mocks, stubs, fakes)
- –¢–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (ms - seconds)
- –¢–µ—Å—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞
- 100% –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ Unit Tests:**

#### Codex Module Tests (`tests/unit/`)
```
tests/unit/
‚îú‚îÄ‚îÄ test_unified_cognitive_loop.py      # UnifiedCognitiveLoop
‚îú‚îÄ‚îÄ test_workspace_layer.py             # Workspace (GlobalFrame, MeritEngine)
‚îú‚îÄ‚îÄ test_cooperative_agents.py           # Analyst/Stabilizer/Predictor/Integrator
‚îú‚îÄ‚îÄ test_narrative_layer.py              # NarrativeGenerator
‚îú‚îÄ‚îÄ test_self_model_integration.py       # SelfModel, AffectiveLayer
‚îú‚îÄ‚îÄ test_reflexivity.py                  # FieldReflexivity
‚îú‚îÄ‚îÄ test_field_*.py                      # Field system (8+ tests)
‚îú‚îÄ‚îÄ test_coordinator_*.py                 # Coordinator tests (5+ tests)
‚îú‚îÄ‚îÄ test_lpi_*.py                        # LPI tests (3+ tests)
‚îú‚îÄ‚îÄ test_causal_memory_layer.py           # CausalMemoryLayer
‚îú‚îÄ‚îÄ test_model_registry.py                # ModelRegistry
‚îú‚îÄ‚îÄ test_capu.py                         # CAPU features extraction
‚îî‚îÄ‚îÄ ... (30+ test files)
```

**–ü—Ä–∏–º–µ—Ä Unit Test:**

```python
def test_analyst_agent_processes_frame(self):
    """Test that AnalystAgent extracts correct insights from GlobalFrame."""
    # Arrange
    frame = create_test_global_frame()
    agent = AnalystAgent(name="test-analyst")
    
    # Act
    output = agent.process(frame)
    
    # Assert
    assert output["agent"] == "test-analyst"
    assert "insight" in output
    assert output["confidence"] >= 0.0
```

#### Smoke Tests (`tests/smoke/`) ‚Äî 19 —Ç–µ—Å—Ç–æ–≤

**–¶–µ–ª—å:** –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç.

```
tests/smoke/
‚îú‚îÄ‚îÄ test_agent_loop.py            # AgentLoop
‚îú‚îÄ‚îÄ test_agent_events.py          # Event system
‚îú‚îÄ‚îÄ test_agent_metrics.py         # Metrics
‚îú‚îÄ‚îÄ test_agent_task_done.py        # Task completion
‚îú‚îÄ‚îÄ test_breaker.py                # CircuitBreaker
‚îú‚îÄ‚îÄ test_config_loader.py          # Config loading
‚îú‚îÄ‚îÄ test_cotcore_prompt.py         # COT Core
‚îú‚îÄ‚îÄ test_entrypoint_imports.py      # Imports
‚îú‚îÄ‚îÄ test_event_contract.py         # Event contracts
‚îú‚îÄ‚îÄ test_llm_errors.py             # LLM error handling
‚îî‚îÄ‚îÄ test_temporal.py               # TemporalContext
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: < 5 —Å–µ–∫—É–Ω–¥
- –ü–æ–∫—Ä—ã—Ç–∏–µ: –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—É—Ç–∏
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: –º–∏–Ω–∏–º—É–º (–≤—Å–µ –º–æ–∫–∞–µ—Ç—Å—è)

---

### 2. üü° Integration Tests (–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)

**–¶–µ–ª—å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

**–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

```
tests/integration/
‚îú‚îÄ‚îÄ test_agent_coordination.py      # Agent -> Workspace integration
‚îú‚îÄ‚îÄ test_memory_persistence.py     # CausalMemory -> Disk
‚îú‚îÄ‚îÄ test_model_selection.py        # Selector -> Registry -> Loader
‚îî‚îÄ‚îÄ test_loop_to_narrative.py      # Loop -> Narrative integration
```

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç 2-3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–º–µ—Å—Ç–µ
- –ú–æ–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–ë–î, —Å–µ—Ç—å, —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 1-30 —Å–µ–∫—É–Ω–¥
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

---

### 3. üî¥ E2E Tests (–í–µ—Ä—à–∏–Ω–∞ –ø–∏—Ä–∞–º–∏–¥—ã) ‚Äî 8 —Ç–µ—Å—Ç–æ–≤

**–¶–µ–ª—å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

```
tests/e2e/
‚îú‚îÄ‚îÄ test_agent_loop_cancel.py       # Cancel behavior
‚îú‚îÄ‚îÄ test_agent_loop_flow.py         # Full flow
‚îú‚îÄ‚îÄ test_agent_loop_no_cancel.py    # No cancel scenario
‚îú‚îÄ‚îÄ test_agent_observability.py    # Observability events
‚îú‚îÄ‚îÄ test_breaker_flow.py           # CircuitBreaker flow
‚îú‚îÄ‚îÄ test_console_flow.py           # Console entrypoint
‚îú‚îÄ‚îÄ test_ghostgpt_flow.py          # GUI entrypoint
‚îî‚îÄ‚îÄ test_temporal_flow.py           # Temporal context flow
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 5-60 —Å–µ–∫—É–Ω–¥
- –ú–∏–Ω–∏–º—É–º –º–æ–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã)
- –ü–æ–∫—Ä—ã—Ç–∏–µ: –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è: –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

---

## –¢–µ–∫—É—â–µ–µ –ü–æ–∫—Ä—ã—Ç–∏–µ

### –ü–æ –ú–æ–¥—É–ª—è–º

| –ú–æ–¥—É–ª—å | Unit | Smoke | E2E | –°—Ç–∞—Ç—É—Å |
|--------|------|-------|-----|--------|
| **Cognitive Loop** | ‚úÖ | ‚úÖ | ‚úÖ | 100% |
| **Workspace** | ‚úÖ | ‚úÖ | - | 90% |
| **Agents** | ‚úÖ | ‚úÖ | ‚úÖ | 100% |
| **Narrative** | ‚úÖ | - | - | 50% |
| **Self-Model** | ‚úÖ | - | - | 70% |
| **Field System** | ‚úÖ | - | - | 60% |
| **Causal Memory** | ‚úÖ | - | - | 50% |
| **Benchmark** | - | ‚úÖ | - | 30% |
| **Registry** | ‚úÖ | - | - | 50% |
| **Circuit Breaker** | - | ‚úÖ | ‚úÖ | 100% |

### –ú–µ—Ç—Ä–∏–∫–∏

```
Test Statistics (2025-02-07):
‚îú‚îÄ‚îÄ Total Tests:     180
‚îú‚îÄ‚îÄ Unit Tests:      153 (85%)
‚îú‚îÄ‚îÄ Smoke Tests:     19  (10%)
‚îú‚îÄ‚îÄ E2E Tests:       8   (5%)
‚îú‚îÄ‚îÄ Passing:         175 (97%)
‚îî‚îÄ‚îÄ Known Issues:    5   (mock isolation –≤ –ø–æ–ª–Ω–æ–º —Å—å—é—Ç–µ)
```

---

## –ó–∞–ø—É—Å–∫ –¢–µ—Å—Ç–æ–≤

### –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (Smoke + Unit)
```bash
# –¢–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã
python -m pytest tests/unit/ tests/smoke/ -v --tb=short
```

### –ü–æ–ª–Ω—ã–π —Å—å—é—Ç
```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
python -m pytest tests/ -v
```

### –ü–æ —Ñ–∞–π–ª—É
```bash
# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
python -m pytest tests/unit/test_unified_cognitive_loop.py -v
```

### –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º
```bash
# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
python -m pytest tests/unit/ --cov=codex --cov-report=html
```

---

## Best Practices

### 1. –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ (–∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)
- ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ)
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–º–∏ (unit < 1s, smoke < 5s, e2e < 60s)
- ‚úÖ –ß–∏—Ç–∞–µ–º—ã–º–∏ (–Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ–≤–æ—Ä—è—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ)
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ ( –ø–æ—Ä—è–¥–æ–∫ –Ω–µ –≤–∞–∂–µ–Ω)

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∞ (AAA Pattern)

```python
def test_something():
    # Arrange - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    input_data = create_test_data()
    component = TestComponent()
    
    # Act - –î–µ–π—Å—Ç–≤–∏–µ
    result = component.process(input_data)
    
    # Assert - –ü—Ä–æ–≤–µ—Ä–∫–∞
    assert result.status == "success"
    assert result.data == expected
```

### 3. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

```
test_<module>_<method>_<scenario>
‚îú‚îÄ‚îÄ test_analyst_extracts_insight_from_frame
‚îú‚îÄ‚îÄ test_selector_returns_best_model
‚îú‚îÄ‚îÄ test_global_frame_has_all_required_fields
‚îî‚îÄ‚îÄ test_memory_records_task_success
```

### 4. Mocks –∏ Fixtures

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- `unittest.mock.Mock` - –ø—Ä–æ—Å—Ç—ã–µ –º–æ–∫–∏
- `unittest.mock.MagicMock` - –º–æ–∫–∏ —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
- `pytest.fixture` - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã

**–ò–∑–±–µ–≥–∞—Ç—å:**
- –ú–æ–∫–æ–≤ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (–ø—Ä–∏–∑–Ω–∞–∫ - —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É)
- –ú–æ–∫–æ–≤ —Ç–∞–º, –≥–¥–µ –Ω—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- "–ú–æ–∫–æ–≤ —Ä–∞–¥–∏ –º–æ–∫–æ–≤"

---

## Roadmap –£–ª—É—á—à–µ–Ω–∏–π

### –¢–µ–∫—É—â–∏–π –§–æ–∫—É—Å

- [ ] –î–æ–±–∞–≤–∏—Ç—å Integration Tests –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—É—Ç–µ–π
- [ ] –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ Narrative –¥–æ 80%
- [ ] –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ Causal Memory –¥–æ 80%
- [ ] –î–æ–±–∞–≤–∏—Ç—å property-based —Ç–µ—Å—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ –¶–µ–ª–∏

- [ ] Integration Tests: Agent ‚Üî Workspace ‚Üî Memory
- [ ] Performance Tests: Benchmark stability
- [ ] Load Tests: Concurrent agent execution
- [ ] Mutation Testing: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –¶–µ–ª–∏

- [ ] 90%+ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD
- [ ] Test Impact Analysis

---

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| `pytest` | –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ |
| `unittest` | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ |
| `pytest-cov` | –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ |
| `pytest-mock` | –§–∏–∫—Å—Ç—É—Ä—ã –∏ –º–æ–∫–∏ |
| `unittest.mock` | Mocks –∏ stubs |

---

## –°—Å—ã–ª–∫–∏

- [BUGS.md](./BUGS.md) - –ñ—É—Ä–Ω–∞–ª –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–∞–≥–æ–≤
- [BUG_REPORT_TEMPLATE.md](./BUG_REPORT_TEMPLATE.md) - –®–∞–±–ª–æ–Ω —Ä–µ–ø–æ—Ä—Ç–∞
- scripts/bug_tracker.py - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–∞–Ω–µ—Ä

---

## –û–±–Ω–æ–≤–ª–µ–Ω–æ
2025-02-07
