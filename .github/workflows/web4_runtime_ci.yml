name: Web4 Runtime CI

on:
  workflow_dispatch:
  push:
    paths:
      - "python/**"
      - "rust_core/**"
      - ".github/workflows/web4_runtime_ci.yml"
  pull_request:
    paths:
      - "python/**"
      - "rust_core/**"
      - ".github/workflows/web4_runtime_ci.yml"

concurrency:
  group: web4-runtime-${{ github.ref }}
  cancel-in-progress: true

jobs:
  python-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest ruff mypy requests PyYAML

      - name: Lint (ruff)
        run: |
          ruff check python

      - name: Type check (mypy)
        run: |
          MYPYPATH=python mypy --explicit-package-bases --follow-imports=skip --ignore-missing-imports -p python.modules

      - name: Run Python tests
        run: |
          PYTHONPATH=. pytest python/tests

  rust-pyo3:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust_core

      - name: Create virtual environment and install maturin
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/python -m pip install maturin

      - name: Configure PyO3 interpreter
        run: echo "PYO3_PYTHON=$GITHUB_WORKSPACE/.venv/bin/python" >> "$GITHUB_ENV"

      - name: Build PyO3 module
        working-directory: rust_core
        run: |
          "$PYO3_PYTHON" -m maturin develop --release

      - name: Run Rust tests with extension ABI
        working-directory: rust_core
        run: |
          cargo test --features extension-module

      - name: Run Python smoke test for Rust binding
        run: |
          PYTHONPATH=. "$PYO3_PYTHON" -c "from python.rust_bridge import RustOptimizer; r=RustOptimizer(db_path='./data/ci_patterns.db'); assert r.available, 'Rust binding is not available'; assert r.add_patterns([[0.1,0.2,0.3],[0.4,0.5,0.6]]); assert isinstance(r.find_similar([0.1,0.2,0.3], k=1), list); r.close()"
